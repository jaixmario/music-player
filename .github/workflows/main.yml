name: Android Build and Telegram Notify

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: 4Ô∏è‚É£ Fix gradlew and permissions
        run: |
          sudo apt-get update
          sudo apt-get install -y dos2unix
          dos2unix ./gradlew
          chmod +x ./gradlew

      - name: Build APK
        run: ./gradlew assembleRelease

      - name: Send APK to Telegram via Telebot
        run: |
          python3 <<EOF
          import telebot
          import os
          import subprocess
          from datetime import datetime
          import pytz

          bot = telebot.TeleBot(os.environ["TELEGRAM_BOT_TOKEN"])
          chat_id = os.environ["TELEGRAM_CHAT_ID"]

          def get_output(cmd):
              return subprocess.check_output(cmd, shell=True).decode().strip()

          version_name = get_output("grep 'versionName' app/build.gradle.kts | cut -d '\"' -f2")
          version_code = get_output("grep 'versionCode' app/build.gradle.kts | grep -o '[0-9]\\+'")
          commit_hash = get_output("git rev-parse --short HEAD")
          commit_message = get_output("git log -1 --pretty=%s")
          commit_author = get_output("git log -1 --pretty=format:'%an'")
          ist_time = datetime.now(pytz.timezone("Asia/Kolkata")).strftime("%d %b %Y, %I:%M %p")

          caption = (
              "*‚úÖ Android Build Completed*\n\n"
              f"*Version:* v{version_name} ({version_code})\n"
              f"*Commit:* `{commit_hash}`\n"
              f"*Message:* `{commit_message}`\n"
              f"*Author:* *{commit_author}*\n"
              f"*Time:* {ist_time} (IST)\n\n"
              "üì¶ *Artifact:* app-release.apk"
          )

          apk_path = "app/build/outputs/apk/release/app-release.apk"
          with open(apk_path, "rb") as f:
              bot.send_document(chat_id, f, caption=caption, parse_mode="Markdown")
          EOF
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}